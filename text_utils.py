import re

# разные типы дефисов: -, ‐, ‒, –, —
HYPHENS = r'[-‐-‒–—]'

MARKER_RE = re.compile(r'^[®@Ф\\#]+\s*')


def strip_leading_markers(text: str) -> str:
    return MARKER_RE.sub('', text).strip()


def normalize_text(text: str) -> str:
    """
    Нормализация текста ПОСЛЕ структурной склейки строк.
    Ключевая логика:
    - различаем OCR-разрыв слова (␠\\n)
    - различаем нормальный перенос строки (\\n)
    """

    if not text:
        return ""

    # единый формат переносов
    text = text.replace('\r\n', '\n')

    # --------------------------------------------------
    # 1. OCR-разрыв слова: "худо ␠\nжественной" → "художественной"
    #    КРИТИЧНО: именно пробел + перенос
    # --------------------------------------------------
    text = re.sub(
        r'([а-яА-Я])\s+\n([а-яА-Я])',
        r'\1\2',
        text
    )

    # --------------------------------------------------
    # 2. Дефисный перенос слова: "вымыш-\nленная" → "вымышленная"
    # --------------------------------------------------
    text = re.sub(
        rf'{HYPHENS}\s*\n\s*',
        '',
        text
    )

    # --------------------------------------------------
    # 3. Более двух переносов → абзац
    # --------------------------------------------------
    text = re.sub(r'\n{3,}', '\n\n', text)

    # --------------------------------------------------
    # 4. Одиночные переносы строки внутри абзаца → пробел
    #    (НО уже после обработки OCR-разрывов)
    # --------------------------------------------------
    text = re.sub(r'(?<!\n)\n(?!\n)', ' ', text)

    # --------------------------------------------------
    # 5. Чистка пробелов
    # --------------------------------------------------
    text = re.sub(r'[ \t]{2,}', ' ', text)
    text = re.sub(r' *\n *', '\n', text)

    return text.strip()


def normalize_key(text: str) -> str:
    """
    Используется для TOC / сопоставлений.
    """
    if not text:
        return ""

    text = strip_leading_markers(text)
    text = re.sub(r'\.{2,}', ' ', text)
    text = re.sub(r'\s+\d{1,4}\s*$', '', text)
    text = normalize_text(text)

    text = (
        text.replace('«', '')
            .replace('»', '')
            .replace('"', '')
            .replace("'", '')
    )

    return text.strip()
